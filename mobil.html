<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Letadlová Hra</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        body, html {
            height: 100%;
            margin: 0;
            font-family: Arial, Helvetica, sans-serif;
        }

        #map {
            height: 50%;
        }

        .sidebar {
            height: 50%;
            overflow-y: auto;
            padding: 10px;
            box-sizing: border-box;
            background-color: #f4f4f4;
        }

        .menu {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .menu select {
            flex: 1;
            margin-right: 10px;
        }

        .menu button {
            flex-shrink: 0;
        }

        .info {
            margin-bottom: 20px;
        }

        .sell-icon {
            position: absolute;
            top: 5px;
            right: 5px;
            cursor: pointer;
        }

        .popup-content {
            position: relative;
        }

        @media (max-width: 768px) {
            #map {
                height: 40%;
            }

            .sidebar {
                height: 60%;
            }

            .menu {
                flex-direction: column;
            }

            .menu select, .menu button {
                width: 100%;
                margin-bottom: 10px;
            }
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="sidebar">
        <div class="menu">
            <select id="plane-select">
                <option value="mini">Mini Letadlo (1000 Kč)</option>
                <option value="small">Malé Letadlo (10000 Kč)</option>
                <option value="medium">Střední Letadlo (50000 Kč)</option>
                <option value="large">Velké Letadlo (150000 Kč)</option>
                <option value="jumbo">Velkokapacitní Letadlo (500000 Kč)</option>
            </select>
            <button onclick="buyPlane()">Koupit Letadlo</button>
        </div>
        <div class="info">
            <p id="money">Peněženka: 100 Kč</p>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        let map = L.map('map').setView([50.0755, 14.4378], 5);
        let planeIcon = L.icon({
            iconUrl: 'https://i.imgur.com/dU2KpHP.png',
            iconSize: [32, 32]
        });
        let airports = [
            { name: 'Praha', coords: [50.0755, 14.4378], passengers: {} },
            { name: 'Berlin', coords: [52.5200, 13.4050], passengers: {} },
            { name: 'London', coords: [51.5074, -0.1278], passengers: {} }
        ];
        let planes = [];
        let money = 100;

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 18
        }).addTo(map);

        function updateMoneyDisplay() {
            document.getElementById('money').innerText = 'Peněženka: ' + Math.round(money) + ' Kč';
        }

        function addAirportMarkers() {
            airports.forEach(airport => {
                let marker = L.marker(airport.coords).addTo(map)
                    .bindPopup(generateAirportPopupContent(airport));
                airport.marker = marker;
            });
        }

        function generateAirportPopupContent(airport) {
            let content = '<b>' + airport.name + '</b><br>';
            for (let destination in airport.passengers) {
                if (airport.passengers[destination] > 0) {
                    content += destination + ': ' + airport.passengers[destination] + '<br>';
                }
            }
            return content;
        }

        function generatePlanePopupContent(plane) {
            let content = '<div class="popup-content">';
            content += 'Letadlo: ' + plane.registration + '<br>';
            content += 'Kapacita: ' + plane.capacity + '<br>';
            content += 'Pasažéři: ' + plane.passengers + '<br>';
            content += '<select id="destination-select-' + plane.registration + '">';
            airports.forEach(airport => {
                if (airport.name !== plane.destination) {
                    content += '<option value="' + airport.name + '">' + airport.name + '</option>';
                }
            });
            content += '</select><br>';
            content += '<button onclick="sendPlane(\'' + plane.registration + '\')">Odeslat</button>';
            content += '<img src="https://i.imgur.com/dU2KpHP.png" class="sell-icon" onclick="confirmSellPlane(\'' + plane.registration + '\')" title="Prodat letadlo">';
            content += '</div>';
            return content;
        }

        function buyPlane() {
            let select = document.getElementById('plane-select');
            let type = select.value;
            let cost = { mini: 1000, small: 10000, medium: 50000, large: 150000, jumbo: 500000 };
            let capacity = { mini: 4, small: 30, medium: 70, large: 150, jumbo: 300 };
            let speed = { mini: 2500, small: 2500, medium: 3500, large: 5000, jumbo: 7500 };
            if (money >= cost[type]) {
                money -= cost[type];
                updateMoneyDisplay();
                let registration = 'OK-' + Math.random().toString(36).substr(2, 3).toUpperCase();
                let planeMarker = L.marker(airports[0].coords, { icon: planeIcon }).addTo(map);
                let plane = {
                    registration: registration,
                    capacity: capacity[type],
                    speed: speed[type],
                    passengers: 0,
                    inFlight: false,
                    marker: planeMarker,
                    destination: null
                };
                planes.push(plane);
                plane.marker.bindPopup(generatePlanePopupContent(plane)).openPopup();
            } else {
                alert('Nemáte dostatek peněz na nákup letadla.');
            }
        }

        function updatePopupContent(airport) {
            airport.marker.setPopupContent(generateAirportPopupContent(airport));
        }

        function sendPlane(registration) {
            let plane = planes.find(p => p.registration === registration);
            let select = document.getElementById('destination-select-' + registration);
            let destination = select.value;
            let fromAirport = airports.find(a => a.coords[0] === plane.marker.getLatLng().lat && a.coords[1] === plane.marker.getLatLng().lng);
            if (plane && fromAirport.passengers[destination] > 0) {
                let passengersToLoad = Math.min(plane.capacity, fromAirport.passengers[destination]);
                plane.passengers = passengersToLoad;
                fromAirport.passengers[destination] -= passengersToLoad;
                updatePopupContent(fromAirport);
                plane.destination = destination;
                plane.inFlight = true;
                let toAirport = airports.find(a => a.name === destination);
                flyPlane(plane, fromAirport, toAirport);
                plane.marker.bindPopup(generatePlanePopupContent(plane)).openPopup();
            } else {
                alert('Není dostatek pasažérů pro tuto destinaci!');
            }
        }

        function flyPlane(plane, fromAirport, toAirport) {
            let planeMarker = plane.marker;
            let fromLatLng = L.latLng(fromAirport.coords);
            let toLatLng = L.latLng(toAirport.coords);
            let planePath = [fromLatLng, toLatLng];
            let polyline = L.polyline(planePath, { color: 'blue' }).addTo(map);
            let currentStep = 0;
            let totalSteps = 100;
            let distance = map.distance(fromLatLng, toLatLng) / 1000; // in kilometers
            let travelTime = (distance / plane.speed) * 3600 * 1000; // in milliseconds
            let stepInterval = travelTime / totalSteps;

            let flightInterval = setInterval(function() {
                if (currentStep >= totalSteps) {
                    clearInterval(flightInterval);
                    map.removeLayer(polyline);
                    plane.inFlight = false;
                    plane.passengers = 0;
                    plane.destination = null;
                    plane.marker.setLatLng(toLatLng);
                    let earnings = distance * plane.passengers * 3;
                    money += earnings;
                    updateMoneyDisplay();
                    plane.marker.bindPopup(generatePlanePopupContent(plane)).openPopup();
                    return;
                }
                let currentLatLng = L.latLng(
                    fromLatLng.lat + (toLatLng.lat - fromLatLng.lat) * (currentStep / totalSteps),
                    fromLatLng.lng + (toLatLng.lng - fromLatLng.lng) * (currentStep / totalSteps)
                );
                plane.marker.setLatLng(currentLatLng);
                currentStep++;
            }, stepInterval);
        }

        function confirmSellPlane(registration) {
            if (confirm('Opravdu chcete prodat toto letadlo?')) {
                sellPlane(registration);
            }
        }

        function sellPlane(registration) {
            let planeIndex = planes.findIndex(p => p.registration === registration);
            if (planeIndex > -1) {
                let plane = planes[planeIndex];
                let cost = { mini: 1000, small: 10000, medium: 50000, large: 150000, jumbo: 500000 };
                let planeType = Object.keys(cost).find(type => cost[type] * 0.65 === Math.round(plane.capacity / 4) * 1000 * 0.65);
                let salePrice = cost[planeType] * 0.65;
                money += salePrice;
                updateMoneyDisplay();
                map.removeLayer(plane.marker);
                planes.splice(planeIndex, 1);
            }
        }

        addAirportMarkers();
    </script>
</body>
</html>
